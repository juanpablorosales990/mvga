generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// User & Authentication
// ============================================================================

model User {
  id            String   @id @default(uuid())
  walletAddress String   @unique
  role          String   @default("USER") // USER | ADMIN
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  stakes        Stake[]
  stakingClaims StakingClaim[]
  offers        P2POffer[]     @relation("SellerOffers")
  buyerTrades   P2PTrade[]     @relation("BuyerTrades")
  sellerTrades  P2PTrade[]     @relation("SellerTrades")
  reputation    UserReputation?
  votes         Vote[]

  @@index([walletAddress])
}

model UserReputation {
  id              String @id @default(uuid())
  userId          String @unique
  user            User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  totalTrades     Int    @default(0)
  completedTrades Int    @default(0)
  disputesWon     Int    @default(0)
  disputesLost    Int    @default(0)
  rating          Float  @default(5.0)
  avgResponseTime Int    @default(0) // in minutes

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([rating])
}

// ============================================================================
// Staking
// ============================================================================

model Stake {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount      BigInt    // Amount in smallest unit (lamports)
  lockPeriod  Int       // Lock period in days (0, 30, 90, 180)
  lockedUntil DateTime?

  stakeTx     String?   @unique // Solana transaction signature
  unstakeTx   String?   @unique // Solana transaction signature when unstaked
  autoCompound Boolean  @default(false) // Auto-reinvest rewards

  status        StakeStatus @default(ACTIVE)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  unstakedAt    DateTime?
  lastClaimedAt DateTime?

  @@index([userId])
  @@index([status])
}

enum StakeStatus {
  ACTIVE
  UNSTAKING
  UNSTAKED
}

// ============================================================================
// P2P Exchange
// ============================================================================

model P2POffer {
  id                  String   @id @default(uuid())
  sellerId            String
  seller              User     @relation("SellerOffers", fields: [sellerId], references: [id], onDelete: Cascade)

  type                P2POfferType  // BUY or SELL crypto
  cryptoAmount        BigInt        // Total amount in smallest unit
  availableAmount     BigInt        // Remaining amount
  cryptoCurrency      String        // USDC, MVGA, etc.

  paymentMethod       PaymentMethod
  paymentInstructions String?

  rate                Float         // Exchange rate (1.0 = market rate)
  minAmount           BigInt        // Min trade amount in USD cents
  maxAmount           BigInt        // Max trade amount in USD cents

  status              P2POfferStatus @default(ACTIVE)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  trades              P2PTrade[]

  @@index([sellerId])
  @@index([status])
  @@index([cryptoCurrency])
  @@index([paymentMethod])
}

enum P2POfferType {
  BUY
  SELL
}

enum PaymentMethod {
  ZELLE
  VENMO
  PAYPAL
  BANK_TRANSFER
}

enum P2POfferStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

model P2PTrade {
  id           String   @id @default(uuid())
  offerId      String
  offer        P2POffer @relation(fields: [offerId], references: [id])

  buyerId      String
  buyer        User     @relation("BuyerTrades", fields: [buyerId], references: [id])
  sellerId     String
  seller       User     @relation("SellerTrades", fields: [sellerId], references: [id])

  amount       BigInt   // Trade amount in USD cents
  cryptoAmount BigInt   // Crypto amount in smallest unit

  status       P2PTradeStatus @default(PENDING)
  escrowTx     String?   @unique // Solana tx locking funds
  releaseTx    String?   @unique // Solana tx releasing funds

  disputeReason String?
  disputeEvidence String?
  disputeResolution String?

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  paidAt       DateTime?
  completedAt  DateTime?
  processingAt DateTime?

  @@index([offerId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
}

enum P2PTradeStatus {
  PENDING
  ESCROW_LOCKED
  PAID
  COMPLETED
  DISPUTED
  CANCELLED
  REFUNDED
}

// ============================================================================
// Business Grants
// ============================================================================

model GrantProposal {
  id               String   @id @default(uuid())

  businessName     String
  businessLocation String
  description      String   @db.Text
  requestedAmount  BigInt   // In USD cents
  videoUrl         String?

  applicantAddress String

  status           GrantStatus @default(VOTING)
  votesFor         Int         @default(0)
  votesAgainst     Int         @default(0)

  votingStartedAt  DateTime    @default(now())
  votingEndsAt     DateTime

  fundedAt         DateTime?
  fundingTx        String?     // Solana transaction signature

  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  votes            Vote[]
  updates          GrantUpdate[]

  @@index([status])
  @@index([applicantAddress])
  @@index([votingEndsAt])
}

enum GrantStatus {
  VOTING
  APPROVED
  REJECTED
  FUNDED
  COMPLETED
}

model Vote {
  id          String   @id @default(uuid())
  proposalId  String
  proposal    GrantProposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  voterId     String
  voter       User     @relation(fields: [voterId], references: [id], onDelete: Cascade)

  weight      BigInt   // Based on staked MVGA
  direction   VoteDirection

  createdAt   DateTime @default(now())

  @@unique([proposalId, voterId])
  @@index([proposalId])
  @@index([voterId])
}

enum VoteDirection {
  FOR
  AGAINST
}

model GrantUpdate {
  id          String   @id @default(uuid())
  proposalId  String
  proposal    GrantProposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  title       String
  content     String   @db.Text
  imageUrls   String[] @default([])

  createdAt   DateTime @default(now())

  @@index([proposalId])
}

// ============================================================================
// Referral System
// ============================================================================

model ReferralCode {
  id            String   @id @default(uuid())
  walletAddress String   @unique
  code          String   @unique
  createdAt     DateTime @default(now())

  referrals     Referral[]

  @@index([walletAddress])
  @@index([code])
}

model Referral {
  id               String   @id @default(uuid())
  referrerAddress  String
  refereeAddress   String   @unique
  codeId           String
  code             ReferralCode @relation(fields: [codeId], references: [id])

  bonusPaid        Boolean  @default(false)
  bonusTxReferrer  String?
  bonusTxReferee   String?
  amount           Int      @default(100) // MVGA tokens

  createdAt        DateTime @default(now())

  @@index([referrerAddress])
  @@index([refereeAddress])
}

// ============================================================================
// Transaction Logging
// ============================================================================

model TransactionLog {
  id            String   @id @default(uuid())

  walletAddress String
  type          TransactionType

  signature     String   @unique // Solana transaction signature
  amount        BigInt?
  token         String?

  status        TransactionLogStatus @default(PENDING)
  error         String?

  createdAt     DateTime @default(now())
  confirmedAt   DateTime?

  @@index([walletAddress])
  @@index([type])
  @@index([signature])
  @@index([createdAt])
}

enum TransactionType {
  STAKE
  UNSTAKE
  P2P_ESCROW_LOCK
  P2P_ESCROW_RELEASE
  P2P_ESCROW_REFUND
  GRANT_FUNDING
  SWAP
  TRANSFER
  REFERRAL_BONUS
  BURN
  FEE_REWARD
}

enum TransactionLogStatus {
  PENDING
  CONFIRMED
  FAILED
}

// ============================================================================
// Treasury Distribution (Self-Sustaining Protocol)
// ============================================================================

model TreasuryDistribution {
  id               String   @id @default(uuid())

  // Distribution amounts
  totalAmount      BigInt   // Total collected this period
  burnAmount       BigInt   @default(0) // 5% burned
  liquidityAmount  BigInt   // 40% of distributable to Raydium LP
  stakingAmount    BigInt   // 40% of distributable to staking rewards vault
  grantsAmount     BigInt   // 20% of distributable to humanitarian fund

  // Transaction signatures
  burnTx           String?  // Burn transaction signature
  liquidityTx      String?  // Add liquidity tx
  stakingTx        String?  // Transfer to staking vault tx
  grantsTx         String?  // Transfer to grants treasury tx

  // Revenue sources breakdown
  swapFees         BigInt   @default(0)
  topupFees        BigInt   @default(0)
  giftcardFees     BigInt   @default(0)
  yieldEarnings    BigInt   @default(0)

  status           DistributionStatus @default(PENDING)
  periodStart      DateTime
  periodEnd        DateTime
  executedAt       DateTime?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  steps            DistributionStep[]

  @@index([status])
  @@index([periodEnd])
}

enum DistributionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

model TreasuryBalance {
  id               String   @id @default(uuid())

  // Wallet balances (in smallest units)
  mainWallet       BigInt   @default(0)  // Operating treasury
  liquidityWallet  BigInt   @default(0)  // LP reserves
  stakingWallet    BigInt   @default(0)  // Staking rewards vault
  grantsWallet     BigInt   @default(0)  // Humanitarian fund

  // Cumulative totals
  totalRevenue     BigInt   @default(0)
  totalDistributed BigInt   @default(0)
  totalToLiquidity BigInt   @default(0)
  totalToStaking   BigInt   @default(0)
  totalToGrants    BigInt   @default(0)

  // Snapshot timestamp
  snapshotAt       DateTime @default(now())

  @@index([snapshotAt])
}

model FeeCollection {
  id               String   @id @default(uuid())

  source           FeeSource
  amount           BigInt
  token            String    // USDC, SOL, MVGA
  signature        String?   @unique

  // Related transaction
  relatedTx        String?
  relatedType      String?   // swap, topup, giftcard, yield

  collected        Boolean   @default(false)
  collectedAt      DateTime?

  createdAt        DateTime  @default(now())

  @@index([source])
  @@index([collected])
  @@index([createdAt])
}

enum FeeSource {
  SWAP
  MOBILE_TOPUP
  GIFT_CARD
  YIELD
  P2P
}

// ============================================================================
// Token Burns (Deflationary Mechanism)
// ============================================================================

model TokenBurn {
  id        String     @id @default(uuid())
  amount    BigInt     // Amount burned in smallest units
  signature String     @unique // Solana transaction signature
  source    BurnSource // WEEKLY or MANUAL
  createdAt DateTime   @default(now())

  @@index([createdAt])
}

enum BurnSource {
  WEEKLY
  MANUAL
}

// ============================================================================
// Banking (Card Waitlist)
// ============================================================================

model CardWaitlist {
  id            String   @id @default(uuid())
  walletAddress String
  email         String?
  createdAt     DateTime @default(now())

  @@index([walletAddress])
}

// ============================================================================
// Fee Sharing (Staker Dividends)
// ============================================================================

model FeeSnapshot {
  id           String   @id @default(uuid())
  totalFees    BigInt   // Total fees allocated to stakers this period
  totalWeight  BigInt   // Sum of all stake weights at snapshot time
  feePerWeight Float    // Fees per unit of weight
  periodEnd    DateTime // End of the distribution period
  createdAt    DateTime @default(now())

  @@index([periodEnd])
}

// ============================================================================
// Protocol Metrics
// ============================================================================

model MetricsSnapshot {
  id           String   @id @default(uuid())
  tvl          BigInt   // Total value locked (staking + liquidity + escrow)
  volume24h    BigInt   // 24h transaction volume
  revenue24h   BigInt   // 24h fee revenue
  totalUsers   Int      // Total registered users
  activeUsers  Int      // Users active in last 24h
  totalStakers Int      // Users with active stakes
  totalBurned  BigInt   @default(0) // Cumulative tokens burned
  snapshotAt   DateTime @default(now())

  @@index([snapshotAt])
}

// ============================================================================
// Security Hardening (Auth, Locking, Auditing)
// ============================================================================

model AuthNonce {
  id            String   @id @default(uuid())
  walletAddress String   @unique
  nonce         String
  expiresAt     DateTime
  used          Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([expiresAt])
}

model StakingClaim {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount     BigInt
  feeRewards BigInt   @default(0)
  signature  String   @unique
  claimedAt  DateTime @default(now())

  @@index([userId])
  @@index([claimedAt])
}

model CronLock {
  id          String    @id @default(uuid())
  jobName     String
  lockedBy    String
  lockedAt    DateTime  @default(now())
  expiresAt   DateTime
  completedAt DateTime?

  @@index([expiresAt])
}

model DistributionStep {
  id             String               @id @default(uuid())
  distributionId String
  distribution   TreasuryDistribution @relation(fields: [distributionId], references: [id], onDelete: Cascade)
  stepName       String
  status         String               @default("PENDING")
  signature      String?
  error          String?
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime             @default(now())

  @@unique([distributionId, stepName])
  @@index([distributionId])
}

model VaultReconciliation {
  id                 String   @id @default(uuid())
  vaultType          String   @default("STAKING")
  onChainBalance     BigInt
  dbSum              BigInt
  discrepancy        BigInt
  discrepancyPercent Float
  status             String   @default("OK")
  snapshotAt         DateTime @default(now())

  @@index([snapshotAt])
  @@index([status])
}
